<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è·‘æ­¥æ•™ç·´ V2.9.3 - èƒŒæ™¯å¼·åŒ–ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root { --primary: #ff6a00; --bg: #f0f2f5; --card: #ffffff; --danger: #e74c3c; --success: #2ecc71; --info: #3498db; }
body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #333; padding: 6px; margin: 0; line-height: 1.1; }
.card { background: var(--card); border-radius: 10px; padding: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); margin-bottom: 6px; }
h2 { color: var(--primary); margin: 0 0 5px 0; text-align: center; font-size: 1.2rem; }
table { width: 100%; font-size: 16px; }
td { padding: 4px 1px; text-align: center; border-bottom: 1px solid #eee; }
input[type="number"] { width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 16px; }
.dist-hero { background: #fff8f4; padding: 15px 5px; border-radius: 10px; text-align: center; border: 2px solid var(--primary); margin-bottom: 8px; }
.dist-hero-val { font-size: 3.5rem; font-weight: 900; color: var(--primary); font-family: 'Courier New', monospace; display: block; line-height: 1; }
.dist-hero-unit { font-size: 1rem; color: #777; margin-top: 4px; display: block; }
.display-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin: 5px 0; }
.stat-box { background: #fdfdfd; padding: 8px 1px; border-radius: 6px; text-align: center; border: 1px solid #eee; }
.stat-val { font-size: 18px; font-weight: bold; color: #333; display: block; font-family: monospace; }
.stat-label { font-size: 11px; color: #888; }
.threshold-ctrl { display: flex; align-items: center; justify-content: space-between; gap: 5px; margin-top: 6px; }
.btn-adj { background: #f8f8f8; border: 1px solid #ccc; width: 45px; height: 38px; border-radius: 6px; font-size: 20px; font-weight: bold; }
#thresholdDisplay { font-size: 18px; font-weight: bold; color: var(--primary); flex-grow: 1; text-align: center; }
.btn-main { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 10px; }
.btn-start { background: var(--primary); }
.btn-finish { background: var(--success); display: none; }
#mapModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; flex-direction: column; }
#map { flex-grow: 1; width: 100%; }
.map-tools { padding: 8px; display: flex; justify-content: space-between; align-items: center; background: #fff; border-top: 1px solid #ddd; }
.history-card { background: white; border-radius: 8px; padding: 8px; margin-bottom: 5px; border-left: 4px solid var(--primary); font-size: 14px; }
.history-btns { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.btn-sm { padding: 6px 10px; font-size: 12px; border-radius: 4px; border: none; color: white; cursor: pointer; flex: 1; min-width: 60px; text-align: center; }
#status { text-align: center; font-size: 14px; font-weight: bold; padding: 6px; border-radius: 6px; background: #eee; }
#soundIndicator { text-align: center; font-size: 12px; color: var(--info); margin-top: 4px; font-weight: bold; transition: color 0.3s;}
</style>
</head>
<body>

<div id="mapModal">
  <div style="padding:10px; background:var(--primary); color:white; text-align:center; font-size:16px; font-weight:bold;">ğŸƒ é‹å‹•è»Œè·¡åœ°åœ–</div>
  <div id="map"></div>
  <div class="map-tools">
    <span id="mapInfo" style="font-size:12px; color:#666;">è¼‰å…¥ä¸­...</span>
    <button onclick="closeMap()" style="padding:8px 25px; border-radius:5px; border:1px solid #ccc; background:#fff;">è¿”å›</button>
  </div>
</div>

<div class="card">
  <h2>ğŸƒ è¨“ç·´è¨­å®š</h2>
  <table><tbody id="planBody"></tbody></table>
  <div style="margin-top: 8px; display: flex; align-items: center; justify-content: space-between; font-size: 16px;">
    <div>å¾ªç’°ï¼š<input id="loopCount" type="number" oninput="updateLoops(this.value)"></div>
    <div style="font-size:13px;">æ­¥é€²ï¼š<input id="thresholdStep" type="number" step="0.01" value="0.01" oninput="saveStep(this.value)" style="width:40px;">m</div>
    <div>é è¨ˆ <span id="totalPlanTime" style="color:var(--primary); font-weight:bold;">0</span> åˆ†</div>
  </div>
  <div class="threshold-ctrl">
    <span style="font-size:13px; font-weight:bold; color:#555;">GPSé–€æª»</span>
    <button class="btn-adj" onclick="changeThreshold(-1)">ï¼</button>
    <div id="thresholdDisplay">0.30 m</div>
    <button class="btn-adj" onclick="changeThreshold(1)">ï¼‹</button>
  </div>
</div>

<div class="card">
  <div class="dist-hero">
    <span class="stat-label" style="font-size: 14px;">ç´¯ç©å…¬é‡Œ</span>
    <span id="distance" class="dist-hero-val">0.000</span>
    <span class="dist-hero-unit">KILOMETERS</span>
  </div>
  <div class="display-grid">
    <div class="stat-box"><span class="stat-label">æ™‚é–“</span><span id="elapsed" class="stat-val">00:00</span></div>
    <div class="stat-box"><span class="stat-label">é…é€Ÿ</span><span id="pace" class="stat-val">--:--</span></div>
    <div class="stat-box"><span class="stat-label">å‰©é¤˜</span><span id="countdown" class="stat-val">--</span></div>
  </div>
  <div id="status">æº–å‚™å°±ç·’</div>
  <div id="soundIndicator">ğŸµ éŸ³æ•ˆ A (é«˜éŸ³)</div>
  <p id="gpsInfo" style="font-size:10px; color:#999; text-align:center; margin-top:4px;">ç­‰å¾… GPS è¨Šè™Ÿ...</p>
</div>

<button id="startBtn" onclick="toggleStart()" class="btn-main btn-start">é–‹å§‹è¨“ç·´</button>
<button id="finishBtn" onclick="stopAndSave()" class="btn-main btn-finish">çµæŸä¸¦å„²å­˜ç´€éŒ„</button>

<div style="margin-top: 10px;">
  <strong style="font-size:16px;">æ­·å²ç´€éŒ„</strong>
  <div id="historyList" style="margin-top: 5px;"></div>
</div>

<script>
const DEFAULT_PLAN = [
  { name: 'ç†±èº«', bpm: 180, sec: 180 }, { name: 'é–“æ­‡', bpm: 200, sec: 60 },
  { name: 'è¡åˆº', bpm: 210, sec: 60 }, { name: 'æ¢å¾©', bpm: 190, sec: 120 },
  { name: 'èˆ’ç·©', bpm: 180, sec: 120 }
];
let config = JSON.parse(localStorage.getItem('run_config_v2.9')) || { plan: DEFAULT_PLAN, loops: 10, threshold: 0.40, thresholdStep: 0.01 };
let isRunning = false, elapsedSec = 0, totalDist = 0, lastVibratedKm = 0;
let watchId = null, timerId = null, trackPoints = [], audioCtx = null, lastPos = null, map = null, polyline = null;
let activeSoundIndex = 0;

// --- èƒŒæ™¯åŸ·è¡Œå¼·åŒ–è®Šæ•¸ ---
let wakeLock = null;
let silentLoopId = null;

function initTable() {
  document.getElementById('planBody').innerHTML = config.plan.map((s, i) => `
    <tr><td style="text-align:left;"><b>${s.name}</b></td>
    <td>BPM <input type="number" value="${s.bpm}" oninput="updateConfig(${i},'bpm',this.value)"></td>
    <td>ç§’æ•¸ <input type="number" value="${s.sec}" oninput="updateConfig(${i},'sec',this.value)"></td></tr>
  `).join('');
  document.getElementById('loopCount').value = config.loops;
  document.getElementById('thresholdDisplay').innerText = parseFloat(config.threshold).toFixed(2) + " m";
  document.getElementById('thresholdStep').value = config.thresholdStep;
  calcTotalPlanTime();
}

// è«‹æ±‚é˜²æ­¢è¢å¹•ä¼‘çœ é–å®š
async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      console.log("Wake Lock is active");
    } catch (err) {
      console.error(`${err.name}, ${err.message}`);
    }
  }
}

function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
}

function changeThreshold(dir) {
  const step = parseFloat(document.getElementById('thresholdStep').value) || 0.05;
  config.threshold = Math.max(0, parseFloat(config.threshold) + (dir * step));
  document.getElementById('thresholdDisplay').innerText = config.threshold.toFixed(2) + " m";
  saveCfg();
}
function saveStep(v) { config.thresholdStep = parseFloat(v) || 0.05; saveCfg(); }
function updateConfig(i, k, v) { config.plan[i][k] = parseInt(v)||0; saveCfg(); }
function updateLoops(v) { config.loops = parseInt(v)||1; saveCfg(); }
function saveCfg() { localStorage.setItem('run_config_v2.9', JSON.stringify(config)); calcTotalPlanTime(); }
function calcTotalPlanTime() {
  const p = config.plan;
  const sec = p[0].sec + ((p[1].sec + p[2].sec + p[3].sec) * config.loops) + p[4].sec;
  document.getElementById('totalPlanTime').innerText = (sec/60).toFixed(1);
}

function startGPS() {
  if (!navigator.geolocation) return;
  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude: lat, longitude: lon, accuracy } = pos.coords;
    document.getElementById('gpsInfo').innerText = `ç²¾åº¦: Â±${Math.round(accuracy)}m | é–€æª»: ${config.threshold.toFixed(2)}m`;
    if (accuracy < 60) {
      if (lastPos) {
        const d = haversine(lastPos.lat, lastPos.lon, lat, lon);
        if (d > config.threshold && d < 50) { 
          totalDist += d;
          document.getElementById('distance').innerText = (totalDist/1000).toFixed(3);
          const currentKm = Math.floor(totalDist / 1000);
          if (currentKm > lastVibratedKm) {
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            lastVibratedKm = currentKm;
            activeSoundIndex = 1 - activeSoundIndex; 
            updateSoundIndicator();
          }
          if(totalDist > 10) document.getElementById('pace').innerText = formatTime(Math.floor(elapsedSec/(totalDist/1000)));
        }
      }
      lastPos = { lat, lon };
      trackPoints.push({ lat, lon, time: new Date().toISOString(), dist: totalDist });
    }
  }, null, { enableHighAccuracy: true });
}

function updateSoundIndicator() {
    const indicator = document.getElementById('soundIndicator');
    if (activeSoundIndex === 0) {
        indicator.innerText = "ğŸµ éŸ³æ•ˆ A (é«˜éŸ³)";
        indicator.style.color = "var(--info)";
    } else {
        indicator.innerText = "ğŸµ éŸ³æ•ˆ B (ä½éŸ³)";
        indicator.style.color = "var(--primary)";
    }
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function playBeep() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  if (activeSoundIndex === 0) {
      o.frequency.value = 800; o.type = 'sine';
  } else {
      o.frequency.value = 400; o.type = 'triangle';
  }
  g.gain.value = 0.2;
  o.start(); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
  o.stop(audioCtx.currentTime + 0.12);
}

// ç„¡è²è¨Šè™Ÿï¼šè®“ç³»çµ±èªç‚ºåª’é«”æ’­æ”¾ä¸­ï¼Œé˜²æ­¢ JS å‡çµ
function playSilentBeep() {
  if (!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.value = 0.0001; 
  o.start();
  o.stop(audioCtx.currentTime + 0.01);
}

async function runSession() {
  isRunning = true; elapsedSec = 0; totalDist = 0; lastVibratedKm = 0; trackPoints = []; lastPos = null;
  activeSoundIndex = 0; updateSoundIndicator();
  startGPS();
  timerId = setInterval(() => { elapsedSec++; document.getElementById('elapsed').innerText = formatTime(elapsedSec); }, 1000);
  const p = config.plan;
  await performStage(p[0], "ğŸƒ ç†±èº«ä¸­");
  for (let i = 1; i <= config.loops && isRunning; i++) {
    for (let j = 1; j <= 3 && isRunning; j++) await performStage(p[j], `${i}çµ„:${p[j].name}`);
  }
  if (isRunning) await performStage(p[4], "ğŸš¶ èˆ’ç·©ä¸­");
  if (isRunning) {
    document.getElementById('status').innerText = "âœ¨ é”æ¨™ (è¨˜éŒ„ä¸­)";
    document.getElementById('countdown').innerText = "âˆ";
    const bInt = 60000 / p[4].bpm;
    while(isRunning) { playBeep(); await new Promise(r => setTimeout(r, bInt)); }
  }
}

async function performStage(s, label) {
  if (!isRunning) return;
  document.getElementById('status').innerText = label;
  let rem = s.sec;
  const bInt = 60000 / s.bpm;
  return new Promise(res => {
    let t1 = setInterval(() => { rem--; document.getElementById('countdown').innerText = rem>=0?rem:0; if(rem<=0||!isRunning){ clearInterval(t1); res(); }}, 1000);
    let t2 = setInterval(() => { if(!isRunning || rem<=0){ clearInterval(t2); return; } playBeep(); }, bInt);
  });
}

async function toggleStart() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  
  // èƒŒæ™¯å¼·åŒ–ï¼šå•Ÿå‹•é–å®šèˆ‡éœéŸ³å¾ªç’°
  await requestWakeLock();
  silentLoopId = setInterval(playSilentBeep, 5000); 

  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('finishBtn').style.display = 'block';
  runSession();
}

function stopAndSave() {
  isRunning = false; 
  clearInterval(timerId);
  if (silentLoopId) clearInterval(silentLoopId);
  
  // èƒŒæ™¯å¼·åŒ–ï¼šé‡‹æ”¾é–å®š
  if (wakeLock !== null) {
    wakeLock.release().then(() => { wakeLock = null; });
  }

  if (watchId) navigator.geolocation.clearWatch(watchId);
  if (totalDist > 0 || elapsedSec > 10) {
    const records = JSON.parse(localStorage.getItem('run_history_v2.9') || "[]");
    records.unshift({ id: Date.now(), date: new Date().toLocaleString(), dist: (totalDist/1000).toFixed(3), time: formatTime(elapsedSec), threshold: config.threshold.toFixed(2), points: trackPoints });
    localStorage.setItem('run_history_v2.9', JSON.stringify(records));
  }
  location.reload(); 
}

function renderHistory() {
  const records = JSON.parse(localStorage.getItem('run_history_v2.9') || "[]");
  document.getElementById('historyList').innerHTML = records.map(r => `
    <div class="history-card">
      <div style="color:#888; font-size:11px;">ğŸ“… ${r.date} | â±ï¸ ${r.time}</div>
      <div style="font-weight:bold; margin:4px 0; font-size:16px;">
        ğŸƒ ${r.dist} km 
        <span style="font-size:11px; color:#ff6a00; font-weight:normal; margin-left:8px; border:1px solid #ff6a00; padding:1px 4px; border-radius:3px;">GPSé–€æª»: ${r.threshold || 'N/A'}m</span>
      </div>
      <div class="history-btns">
        <button class="btn-sm" style="background:var(--info);" onclick="viewTrack(${r.id})">è»Œè·¡åœ°åœ–</button>
        <button class="btn-sm" style="background:var(--success);" onclick="editDist(${r.id})">ä¿®æ­£</button>
        <button class="btn-sm" style="background:var(--danger);" onclick="deleteRec(${r.id})">åˆªé™¤</button>
      </div>
    </div>
  `).join('');
}

function viewTrack(id) {
  const r = JSON.parse(localStorage.getItem('run_history_v2.9')).find(r => r.id === id);
  if (!r.points || r.points.length < 2) return alert("ç´€éŒ„ä¸è¶³");
  document.getElementById('mapModal').style.display = 'flex';
  document.getElementById('mapInfo').innerText = `${r.dist} km | ${r.time}`;
  if (!map) {
    map = L.map('map').setView([r.points[0].lat, r.points[0].lon], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(map);
  }
  if (polyline) map.removeLayer(polyline);
  const latlngs = r.points.map(p => [p.lat, p.lon]);
  polyline = L.polyline(latlngs, { color: '#ff6a00', weight: 5 }).addTo(map);
  map.fitBounds(polyline.getBounds(), { padding: [30, 30] });
}

function closeMap() { document.getElementById('mapModal').style.display = 'none'; }

function editDist(id) {
  const records = JSON.parse(localStorage.getItem('run_history_v2.9'));
  const idx = records.findIndex(r => r.id === id);
  const newVal = prompt("ä¿®æ­£é‡Œç¨‹ (km):", records[idx].dist);
  if (newVal) { records[idx].dist = parseFloat(newVal).toFixed(3); localStorage.setItem('run_history_v2.9', JSON.stringify(records)); renderHistory(); }
}

function deleteRec(id) {
  if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) {
    const records = JSON.parse(localStorage.getItem('run_history_v2.9') || "[]").filter(r => r.id !== id);
    localStorage.setItem('run_history_v2.9', JSON.stringify(records));
    renderHistory();
  }
}

window.onload = function() {
  initTable();
  renderHistory();
};
</script>
</body>
</html>
