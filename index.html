<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è·‘æ­¥æ•™ç·´ V3.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root { --primary: #ff6a00; --bg: #f0f2f5; --card: #ffffff; --danger: #e74c3c; --success: #2ecc71; --info: #3498db; --note: #9b59b6; }
body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #333; padding: 6px; margin: 0; line-height: 1.1; }
.card { background: var(--card); border-radius: 10px; padding: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); margin-bottom: 6px; }
h2 { color: var(--primary); margin: 0 0 5px 0; text-align: center; font-size: 1.2rem; }
table { width: 100%; font-size: 16px; }
td { padding: 4px 1px; text-align: center; border-bottom: 1px solid #eee; }
input[type="number"] { width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 16px; }

.display-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin: 5px 0; }
.stat-box { background: #fff8f4; padding: 6px 1px; border-radius: 6px; text-align: center; border: 1px solid #ffe0cc; }
.stat-val { font-size: 15px; font-weight: bold; color: var(--primary); display: block; font-family: monospace; }
.stat-label { font-size: 10px; color: #777; }

.threshold-ctrl { display: flex; align-items: center; justify-content: space-between; gap: 5px; margin-top: 6px; }
.btn-adj { background: #f8f8f8; border: 1px solid #ccc; width: 45px; height: 38px; border-radius: 6px; font-size: 20px; font-weight: bold; }
#thresholdDisplay { font-size: 18px; font-weight: bold; color: var(--primary); flex-grow: 1; text-align: center; }

.btn-main { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 10px; }
.btn-start { background: var(--primary); }
.btn-finish { background: var(--success); display: none; }

#mapModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; flex-direction: column; }
#map { flex-grow: 1; width: 100%; }
.map-tools { padding: 8px; display: flex; justify-content: space-between; align-items: center; background: #fff; border-top: 1px solid #ddd; }

.history-card { background: white; border-radius: 8px; padding: 8px; margin-bottom: 5px; border-left: 4px solid var(--primary); font-size: 14px; }
.history-btns { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.btn-sm { padding: 6px 4px; font-size: 11px; border-radius: 4px; border: none; color: white; cursor: pointer; flex: 1; min-width: 55px; text-align: center; }

#status { text-align: center; font-size: 14px; font-weight: bold; padding: 6px; border-radius: 6px; background: #eee; }
</style>
</head>
<body>

<div id="mapModal">
  <div style="padding:10px; background:var(--primary); color:white; text-align:center; font-size:16px; font-weight:bold;">ğŸƒ é‹å‹•è»Œè·¡åœ°åœ–</div>
  <div id="map"></div>
  <div class="map-tools">
    <span id="mapInfo" style="font-size:12px; color:#666;">è¼‰å…¥ä¸­...</span>
    <button onclick="closeMap()" style="padding:8px 25px; border-radius:5px; border:1px solid #ccc; background:#fff;">è¿”å›</button>
  </div>
</div>

<div class="card">
  <h2>ğŸƒ è¨“ç·´è¨­å®š (V3.0)</h2>
  <table><tbody id="planBody"></tbody></table>
  <div style="margin-top: 8px; display: flex; align-items: center; justify-content: space-between; font-size: 16px;">
    <div>å¾ªç’°ï¼š<input id="loopCount" type="number" oninput="updateLoops(this.value)"></div>
    <div style="font-size:13px;">æ­¥é€²ï¼š<input id="thresholdStep" type="number" step="0.01" value="0.05" oninput="saveStep(this.value)" style="width:40px;">m</div>
    <div>é è¨ˆ <span id="totalPlanTime" style="color:var(--primary); font-weight:bold;">0</span> åˆ†</div>
  </div>
  <div class="threshold-ctrl">
    <span style="font-size:13px; font-weight:bold; color:#555;">GPSé–€æª»</span>
    <button class="btn-adj" onclick="changeThreshold(-1)">ï¼</button>
    <div id="thresholdDisplay">0.30 m</div>
    <button class="btn-adj" onclick="changeThreshold(1)">ï¼‹</button>
  </div>
</div>

<div class="card">
  <div class="display-grid">
    <div class="stat-box"><span class="stat-label">æ™‚é–“</span><span id="elapsed" class="stat-val">00:00</span></div>
    <div class="stat-box"><span class="stat-label">å…¬é‡Œ</span><span id="distance" class="stat-val">0.000</span></div>
    <div class="stat-box"><span class="stat-label">é…é€Ÿ</span><span id="pace" class="stat-val">--:--</span></div>
    <div class="stat-box"><span class="stat-label">å‰©é¤˜</span><span id="countdown" class="stat-val">--</span></div>
  </div>
  <div id="status">æº–å‚™å°±ç·’</div>
  <p id="gpsInfo" style="font-size:10px; color:#999; text-align:center; margin-top:4px;">ç­‰å¾… GPS è¨Šè™Ÿ...</p>
</div>

<button id="startBtn" onclick="toggleStart()" class="btn-main btn-start">é–‹å§‹è¨“ç·´</button>
<button id="finishBtn" onclick="stopAndSave()" class="btn-main btn-finish">çµæŸä¸¦å„²å­˜ç´€éŒ„</button>

<div style="margin-top: 10px;">
  <strong style="font-size:16px;">æ­·å²ç´€éŒ„</strong>
  <div id="historyList" style="margin-top: 5px;"></div>
</div>

<script>
/* ---------------- è³‡æ–™èˆ‡è¨­å®š ---------------- */
const DEFAULT_PLAN = [{ name:'ç†±èº«',bpm:180,sec:180 },{ name:'200é–“æ­‡',bpm:200,sec:60 },{ name:'210è¡åˆº',bpm:210,sec:60 },{ name:'190æ¢å¾©',bpm:190,sec:120 },{ name:'èˆ’ç·©',bpm:180,sec:180 }];
let config = JSON.parse(localStorage.getItem('run_config_v3.0')) || { plan: DEFAULT_PLAN, loops: 5, threshold: 0.30, thresholdStep: 0.05 };
let isRunning = false, elapsedSec = 0, totalDist = 0, lastVibratedKm = 0;
let watchId = null, timerId = null, trackPoints = [], audioCtx = null, lastPos = null, map = null, polyline = null;
let startNote = { location: "å®šä½ä¸­...", weather: "æŠ“å–ä¸­..." };

function initTable() {
  document.getElementById('planBody').innerHTML = config.plan.map((s, i) => `<tr><td style="text-align:left;"><b>${s.name}</b></td><td>BPM <input type="number" value="${s.bpm}" oninput="updateConfig(${i},'bpm',this.value)"></td><td>ç§’æ•¸ <input type="number" value="${s.sec}" oninput="updateConfig(${i},'sec',this.value)"></td></tr>`).join('');
  document.getElementById('loopCount').value = config.loops;
  document.getElementById('thresholdDisplay').innerText = parseFloat(config.threshold).toFixed(2) + " m";
  document.getElementById('thresholdStep').value = config.thresholdStep;
  calcTotalPlanTime();
}

/* ---------------- æ™ºæ…§æ ¸å¿ƒé‚è¼¯ ---------------- */
async function fetchStartInfo(lat, lon) {
  try {
    // 1. æŠ“å–åœ°é» (Nominatim)
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`, { headers: { 'Accept-Language': 'zh-TW' } })
      .then(res => res.json()).then(data => { startNote.location = data.display_name.split(',')[0] || "æœªçŸ¥åœ°é»"; });
    // 2. æŠ“å–å¤©æ°£ (Open-Meteo)
    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
      .then(res => res.json()).then(data => {
        const w = data.current_weather;
        const codes = { 0:"æ™´æœ—", 1:"æ™´æ™‚å¤šé›²", 2:"å¤šé›²", 3:"é™°å¤©", 45:"éœ§", 48:"éœ§", 51:"æ¯›æ¯›é›¨", 61:"å°é›¨", 71:"å°é›ª", 95:"é›·é›¨" };
        startNote.weather = `${codes[w.weathercode] || "åæ™´"}ï¼Œæ°£æº« ${w.temperature}Â°C`;
      });
  } catch (e) { startNote.location = "é€£ç·šå¤±æ•—"; }
}

function startGPS() {
  if (!navigator.geolocation) return;
  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude: lat, longitude: lon, accuracy } = pos.coords;
    document.getElementById('gpsInfo').innerText = `ç²¾åº¦: Â±${Math.round(accuracy)}m | é–€æª»: ${config.threshold.toFixed(2)}m`;
    if (accuracy < 60) {
      if (!lastPos) fetchStartInfo(lat, lon); // ç¬¬ä¸€æ¬¡ç©©å®šå®šä½æ™‚æŠ“å–å¤©æ°£èˆ‡åœ°é»
      if (lastPos) {
        const d = haversine(lastPos.lat, lastPos.lon, lat, lon);
        if (d > config.threshold && d < 50) { 
          totalDist += d;
          document.getElementById('distance').innerText = (totalDist/1000).toFixed(3);
          const curKm = Math.floor(totalDist / 1000);
          if (curKm > lastVibratedKm) { if (navigator.vibrate) navigator.vibrate([500, 200, 500]); lastVibratedKm = curKm; }
          if(totalDist > 10) document.getElementById('pace').innerText = formatTime(Math.floor(elapsedSec/(totalDist/1000)));
        }
      }
      lastPos = { lat, lon };
      trackPoints.push({ lat, lon, time: new Date().toISOString(), dist: totalDist });
    }
  }, null, { enableHighAccuracy: true });
}

async function runSession() {
  isRunning = true; elapsedSec = 0; totalDist = 0; lastVibratedKm = 0; trackPoints = []; lastPos = null;
  startGPS();
  timerId = setInterval(() => { elapsedSec++; document.getElementById('elapsed').innerText = formatTime(elapsedSec); }, 1000);
  const p = config.plan;
  
  // æ™ºæ…§åˆ¤æ–·ï¼šå¦‚æœç§’æ•¸ > 0 æ‰åŸ·è¡Œè©²éšæ®µ
  if (p[0].sec > 0) await performStage(p[0], "ğŸƒ ç†±èº«ä¸­");
  
  for (let i = 1; i <= config.loops && isRunning; i++) {
    for (let j = 1; j <= 3 && isRunning; j++) {
      if (p[j].sec > 0) await performStage(p[j], `${i}çµ„:${p[j].name}`);
    }
  }
  
  if (isRunning && p[4].sec > 0) await performStage(p[4], "ğŸš¶ èˆ’ç·©ä¸­");
  
  if (isRunning) {
    document.getElementById('status').innerText = "âœ¨ é”æ¨™ (è¨˜éŒ„ä¸­)";
    const bInt = 60000 / p[4].bpm;
    while(isRunning) { playBeep(); await new Promise(r => setTimeout(r, bInt)); }
  }
}

/* ---------------- åŸºç¤åŠŸèƒ½ ---------------- */
function haversine(lat1, lon1, lat2, lon2) { const R = 6371000; const dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180; const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
function playBeep() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = 800; g.gain.value = 0.2; o.start(); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); o.stop(audioCtx.currentTime + 0.12); }
async function performStage(s, label) { if (!isRunning) return; document.getElementById('status').innerText = label; let rem = s.sec; const bInt = 60000/s.bpm; return new Promise(res => { let t1 = setInterval(() => { rem--; document.getElementById('countdown').innerText = rem>=0?rem:0; if(rem<=0||!isRunning){ clearInterval(t1); res(); }}, 1000); let t2 = setInterval(() => { if(!isRunning || rem<=0){ clearInterval(t2); return; } playBeep(); }, bInt); }); }
function toggleStart() { if(audioCtx) audioCtx.resume(); document.getElementById('startBtn').style.display='none'; document.getElementById('finishBtn').style.display='block'; runSession(); }
function stopAndSave() { isRunning = false; clearInterval(timerId); if (watchId) navigator.geolocation.clearWatch(watchId); if (totalDist > 0 || elapsedSec > 10) { const records = JSON.parse(localStorage.getItem('run_history_v3.0') || "[]"); records.unshift({ id: Date.now(), date: new Date().toLocaleString(), dist: (totalDist/1000).toFixed(3), time: formatTime(elapsedSec), points: trackPoints, note: startNote }); localStorage.setItem('run_history_v3.0', JSON.stringify(records)); } location.reload(); }
function changeThreshold(dir) { const step = parseFloat(document.getElementById('thresholdStep').value)||0.05; config.threshold = Math.max(0, parseFloat(config.threshold)+(dir*step)); document.getElementById('thresholdDisplay').innerText = config.threshold.toFixed(2)+" m"; saveCfg(); }
function saveStep(v) { config.thresholdStep = parseFloat(v)||0.05; saveCfg(); }
function updateConfig(i, k, v) { config.plan[i][k] = parseInt(v)||0; saveCfg(); }
function updateLoops(v) { config.loops = parseInt(v)||1; saveCfg(); }
function saveCfg() { localStorage.setItem('run_config_v3.0', JSON.stringify(config)); calcTotalPlanTime(); }
function calcTotalPlanTime() { const p = config.plan; const sec = p[0].sec + ((p[1].sec + p[2].sec + p[3].sec) * config.loops) + p[4].sec; document.getElementById('totalPlanTime').innerText = (sec/60).toFixed(1); }
function formatTime(s) { return Math.floor(s/60).toString().padStart(2,'0')+":"+(s%60).toString().padStart(2,'0'); }

/* ---------------- æ­·å²èˆ‡å‚™è¨» ---------------- */
function renderHistory() {
  const records = JSON.parse(localStorage.getItem('run_history_v3.0') || "[]");
  document.getElementById('historyList').innerHTML = records.map(r => `
    <div class="history-card">
      <div style="color:#888; font-size:11px;">ğŸ“… ${r.date} | â±ï¸ ${r.time}</div>
      <div style="font-weight:bold; margin:2px 0;">ğŸƒ ${r.dist} km</div>
      <div class="history-btns">
        <button class="btn-sm" style="background:var(--info);" onclick="viewTrack(${r.id})">è»Œè·¡</button>
        <button class="btn-sm" style="background:var(--note);" onclick="showNote(${r.id})">å‚™è¨»</button>
        <button class="btn-sm" style="background:var(--success);" onclick="editDist(${r.id})">ä¿®æ­£</button>
        <button class="btn-sm" style="background:var(--danger);" onclick="deleteRec(${r.id})">åˆªé™¤</button>
      </div>
    </div>
  `).join('');
}
function showNote(id) {
  const r = JSON.parse(localStorage.getItem('run_history_v3.0')).find(r => r.id === id);
  const note = r.note || { location: "ç„¡è³‡æ–™", weather: "ç„¡è³‡æ–™" };
  alert(`ğŸ“ èµ·è·‘åœ°é»ï¼š\n${note.location}\n\nğŸŒ¤ï¸ å¤©æ°£æ°£æº«ï¼š\n${note.weather}`);
}
function viewTrack(id) {
  const r = JSON.parse(localStorage.getItem('run_history_v3.0')).find(r => r.id === id);
  if (!r.points || r.points.length < 2) return alert("ç´€éŒ„ä¸è¶³");
  document.getElementById('mapModal').style.display = 'flex';
  document.getElementById('mapInfo').innerText = `${r.dist} km | ${r.time}`;
  if (!map) { map = L.map('map').setView([r.points[0].lat, r.points[0].lon], 16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(map); }
  if (polyline) map.removeLayer(polyline);
  const latlngs = r.points.map(p => [p.lat, p.lon]);
  polyline = L.polyline(latlngs, { color: '#ff6a00', weight: 5 }).addTo(map);
  map.fitBounds(polyline.getBounds(), { padding: [30, 30] });
}
function closeMap() { document.getElementById('mapModal').style.display = 'none'; }
function editDist(id) { const records = JSON.parse(localStorage.getItem('run_history_v3.0')); const idx = records.findIndex(r => r.id === id); const newVal = prompt("ä¿®æ­£é‡Œç¨‹ (km):", records[idx].dist); if (newVal) { records[idx].dist = parseFloat(newVal).toFixed(3); localStorage.setItem('run_history_v3.0', JSON.stringify(records)); renderHistory(); } }
function deleteRec(id) { if (confirm("ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ")) { const records = JSON.parse(localStorage.getItem('run_history_v3.0')).filter(r => r.id !== id); localStorage.setItem('run_history_v3.0', JSON.stringify(records)); renderHistory(); } }

window.onload = () => { initTable(); renderHistory(); };
</script>
</body>
</html>
