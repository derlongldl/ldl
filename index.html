<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è·‘æ­¥æ•™ç·´ V4.5.8</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root { --primary: #ff6a00; --bg: #f0f2f5; --card: #ffffff; --danger: #e74c3c; --success: #2ecc71; --info: #3498db; --note: #9b59b6; }
body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 5px; }
.card { background: var(--card); border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; }
h2 { text-align:center; color:var(--primary); margin:5px 0; }
table { width: 100%; border-collapse: collapse; }
td { padding: 8px 2px; border-bottom: 1px solid #eee; text-align: center; }
input { width: 65px; padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }

/* è¨“ç·´ä»‹é¢ */
#trainingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #fff; z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
.big-val { font-size: 5rem; font-weight: 900; color: var(--primary); font-family: monospace; }

/* è‡ªå®šç¾©å‚™è¨»ç·¨è¼¯å™¨ */
#noteModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 30000; justify-content: center; align-items: center; }
.note-content { background: white; width: 90%; border-radius: 15px; padding: 20px; box-sizing: border-box; }
.note-content h3 { margin-top: 0; color: var(--note); }
#noteArea { width: 100%; height: 120px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; font-size: 1.1rem; box-sizing: border-box; line-height: 1.5; }
.note-btns { display: flex; gap: 10px; margin-top: 15px; }
.btn-note-save { flex: 1; padding: 12px; background: var(--success); color: white; border: none; border-radius: 8px; font-weight: bold; }
.btn-note-cancel { flex: 1; padding: 12px; background: #888; color: white; border: none; border-radius: 8px; }

/* æ­·å²ç´€éŒ„å¡ç‰‡ */
.history-card { background: white; border-radius: 10px; padding: 10px; margin-bottom: 8px; border-left: 5px solid var(--primary); }
.history-btns { display: flex; gap: 4px; margin-top: 8px; }
.btn-sm { flex: 1; padding: 8px 2px; font-size: 12px; border-radius: 5px; border: none; color: white; cursor: pointer; }
.btn-start { width: 100%; padding: 15px 5px; border: none; border-radius: 12px; color: white; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top:10px; }
</style>
</head>
<body>

<div id="noteModal">
    <div class="note-content">
        <h3>ğŸ“ ç·¨è¼¯è·‘æ­¥å‚™è¨»</h3>
        <textarea id="noteArea" placeholder="è«‹è¼¸å…¥å‚™è¨»..."></textarea>
        <div class="note-btns">
            <button class="btn-note-cancel" onclick="closeNote()">å–æ¶ˆ</button>
            <button class="btn-note-save" onclick="saveNote()">å„²å­˜å‚™è¨»</button>
        </div>
    </div>
</div>

<div id="trainingOverlay">
  <div id="statusTop" style="font-size: 3rem; font-weight: bold; color: var(--success);">â— æº–å‚™ä¸­</div>
  <div id="phaseDetail" style="font-size: 1.6rem; color: #ffeb3b; margin-bottom: 20px;">ç¯€æ‹ -- | å‰©é¤˜ -- ç§’</div>
  <div class="label" style="color:#888;">ç´¯ç©å…¬é‡Œ KM</div>
  <div id="bigDistance" class="big-val">0.000</div>
  <div id="soundMode" style="color: var(--info); font-size: 14px; margin-top: -10px;">ğŸµ éŸ³æ•ˆ A (å¼·åŒ–éŸ³)</div>
  <div style="display: flex; width: 100%; justify-content: space-around; margin-top: 10px;">
    <div><div class="label">é…é€Ÿ</div><div id="bigPace" style="font-size: 2.5rem; font-family: monospace;">--:--</div></div>
    <div><div class="label">æ™‚é–“</div><div id="bigElapsed" style="font-size: 2.5rem; font-family: monospace;">00:00</div></div>
  </div>
  <button class="btn-start" style="width: 85%; background: var(--danger); margin-top: 20px;" onclick="stopAndSave()">çµæŸä¸¦å„²å­˜</button>
</div>

<div class="card">
  <h2>ğŸƒ è·‘æ­¥æ•™ç·´ V4.5.8</h2>
  <table>
    <tbody>
      <tr><td><b>ç†±èº«</b></td><td>BPM <input type="number" id="bpm0"></td><td>ç§’ <input type="number" id="sec0"></td></tr>
      <tr><td><b>é–“æ­‡</b></td><td>BPM <input type="number" id="bpm1"></td><td>ç§’ <input type="number" id="sec1"></td></tr>
      <tr><td><b>è¡åˆº</b></td><td>BPM <input type="number" id="bpm2"></td><td>ç§’ <input type="number" id="sec2"></td></tr>
      <tr><td><b>æ¢å¾©</b></td><td>BPM <input type="number" id="bpm3"></td><td>ç§’ <input type="number" id="sec3"></td></tr>
      <tr><td><b>èˆ’ç·©</b></td><td>BPM <input type="number" id="bpm4"></td><td>ç§’ <input type="number" id="sec4"></td></tr>
    </tbody>
  </table>
  <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button onclick="toggleStart(true)" class="btn-start" style="background:var(--primary); flex:1; margin-right:5px;">1 é”æ¨™å¾Œå„²å­˜</button>
      <button onclick="toggleStart(false)" class="btn-start" style="background:var(--info); flex:1;">2 é”æ¨™å¾ŒçºŒè·‘</button>
  </div>
</div>

<div class="card">
    <strong style="display:block; margin-bottom:10px;">æ­·å²ç´€éŒ„</strong>
    <div id="historyContainer"></div>
</div>

<script>
const HISTORY_KEY = 'run_history_v458'; 
const CONFIG_KEY = 'run_config_v458';
const DEFAULT_BPM = [180, 205, 215, 195, 180];
const DEFAULT_SEC = [180, 60, 60, 120, 180];

let config = { bpm: [...DEFAULT_BPM], sec: [...DEFAULT_SEC], loops: 1, threshold: 0.30, step: 0.01 };
let isRunning = false, totalDist = 0, elapsedSec = 0;
let audioCtx = null, currentEditingId = null;
let startNote = { location: "ç²å–ä¸­...", weather: "ç²å–ä¸­..." };

function forceRender() {
    const saved = localStorage.getItem(CONFIG_KEY);
    if (saved) { try { Object.assign(config, JSON.parse(saved)); } catch(e) {} }
    for(let i=0; i<5; i++) {
        document.getElementById('bpm'+i).value = config.bpm[i] || DEFAULT_BPM[i];
        document.getElementById('sec'+i).value = config.sec[i] || DEFAULT_SEC[i];
    }
    renderHistory();
}

function stopAndSave() {
  isRunning = false;
  if (totalDist > 0) {
    const records = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    // å¼·åˆ¶åˆ†è¡Œå­˜å…¥æ•¸æ“šåº«
    const finalNote = `ğŸ“ èµ·é»ï¼š${startNote.location}\nâ˜€ï¸ å¤©æ°£ï¼š${startNote.weather}`;
    records.unshift({ 
        id: Date.now(), date: new Date().toLocaleString(), dist: (totalDist/1000).toFixed(3), 
        time: formatTime(elapsedSec), note: finalNote
    });
    localStorage.setItem(HISTORY_KEY, JSON.stringify(records));
  }
  location.reload();
}

// --- å‚™è¨»ç·¨è¼¯å™¨é‚è¼¯ ---
function editNote(id) {
    currentEditingId = id;
    let recs = JSON.parse(localStorage.getItem(HISTORY_KEY));
    let rec = recs.find(r => r.id === id);
    document.getElementById('noteArea').value = rec.note || "";
    document.getElementById('noteModal').style.display = 'flex';
}

function closeNote() {
    document.getElementById('noteModal').style.display = 'none';
}

function saveNote() {
    let recs = JSON.parse(localStorage.getItem(HISTORY_KEY));
    let idx = recs.findIndex(r => r.id === currentEditingId);
    if (idx !== -1) {
        recs[idx].note = document.getElementById('noteArea').value;
        localStorage.setItem(HISTORY_KEY, JSON.stringify(recs));
        renderHistory();
    }
    closeNote();
}

function renderHistory() {
  const rec = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  document.getElementById('historyContainer').innerHTML = rec.length ? rec.map(r => `
    <div class="history-card">
        <div style="font-size:12px; color:#666;">ğŸ“… ${r.date}</div>
        <b style="font-size:1.3rem; color:var(--primary);">ğŸƒ ${r.dist} km (${r.time})</b>
        <div style="white-space: pre-wrap; font-size: 14px; margin-top:5px; color:#444; background:#f9f9f9; padding:5px; border-radius:5px;">${r.note}</div>
        <div class="history-btns">
            <button class="btn-sm" style="background:var(--note);" onclick="editNote(${r.id})">ä¿®æ”¹å‚™è¨»</button>
            <button class="btn-sm" style="background:var(--danger);" onclick="deleteRec(${r.id})">åˆªé™¤</button>
        </div>
    </div>
  `).join('') : '<div style="text-align:center;color:#aaa;padding:20px;">ç„¡ç´€éŒ„</div>';
}

function deleteRec(id) { if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { let recs = JSON.parse(localStorage.getItem(HISTORY_KEY)).filter(r => r.id !== id); localStorage.setItem(HISTORY_KEY, JSON.stringify(recs)); renderHistory(); } }
function formatTime(s) { return Math.floor(s/60).toString().padStart(2,'0')+":"+(s%60).toString().padStart(2,'0'); }

// å…¶é¤˜åŠŸèƒ½(GPS/éŸ³æ•ˆ)ç¶­æŒ V4.5.7 é‚è¼¯...
async function toggleStart(isAuto) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    document.getElementById('trainingOverlay').style.display = 'flex';
    isRunning = true;
    // æ¨¡æ“¬ç²å–ä½ç½®å¤©æ°£ (å¯¦éš›æœƒç”± GPS è§¸ç™¼)
    setTimeout(() => { startNote.location = "å®œè˜­ç¸£å†¬å±±é„‰"; startNote.weather = "17.3Â°C"; }, 1000);
}

window.onload = forceRender;
</script>
</body>
</html>
