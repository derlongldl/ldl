<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è·‘æ­¥æ•™ç·´ V4.5.9</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root { --primary: #ff6a00; --bg: #f0f2f5; --card: #ffffff; --danger: #e74c3c; --success: #2ecc71; --info: #3498db; --note: #9b59b6; }
body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 5px; }
.card { background: var(--card); border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; }
h2 { text-align:center; color:var(--primary); margin:5px 0; }
table { width: 100%; border-collapse: collapse; }
td { padding: 6px 2px; border-bottom: 1px solid #eee; text-align: center; }
input { width: 60px; padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }

/* æ§åˆ¶å€å¡Šä½ˆå±€ */
.ctrl-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
.thres-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 5px; border-top: 1px dashed #ccc; }

/* å‚™è¨»ç·¨è¼¯å™¨ Modal */
#noteModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 30000; justify-content: center; align-items: center; }
.note-box { background: white; width: 85%; border-radius: 15px; padding: 20px; }
#noteArea { width: 100%; height: 150px; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1.1rem; line-height: 1.6; }

/* è¨“ç·´ä»‹é¢ */
#trainingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #fff; z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
.big-val { font-size: 5rem; font-weight: 900; color: var(--primary); font-family: monospace; }
.btn-start { width: 100%; padding: 15px 5px; border: none; border-radius: 12px; color: white; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top:10px; }

/* æ­·å²ç´€éŒ„ */
.history-card { background: white; border-radius: 10px; padding: 10px; margin-bottom: 8px; border-left: 5px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.note-display { white-space: pre-wrap; background: #f4f4f4; padding: 8px; border-radius: 5px; margin: 8px 0; font-size: 14px; color: #333; border-left: 3px solid var(--note); }
</style>
</head>
<body>

<div id="noteModal">
    <div class="note-box">
        <h3 style="margin:0; color:var(--note);">ğŸ“ ç·¨è¼¯è·‘æ­¥å‚™è¨»</h3>
        <textarea id="noteArea"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="closeNote()" style="flex:1; padding:12px; border:none; border-radius:8px; background:#888; color:white;">å–æ¶ˆ</button>
            <button onclick="saveNote()" style="flex:1; padding:12px; border:none; border-radius:8px; background:var(--success); color:white; font-weight:bold;">å„²å­˜</button>
        </div>
    </div>
</div>

<div id="trainingOverlay">
  <div id="statusTop" style="font-size: 2.5rem; font-weight: bold; color: var(--success);">â— æº–å‚™ä¸­</div>
  <div id="phaseDetail" style="font-size: 1.4rem; color: #ffeb3b; margin-bottom: 15px;">ç¯€æ‹ -- | å‰©é¤˜ -- ç§’</div>
  <div style="color:#888;">ç´¯ç©å…¬é‡Œ KM</div>
  <div id="bigDistance" class="big-val">0.000</div>
  <div id="soundMode" style="color: var(--info); font-size: 14px; margin-bottom: 10px;">ğŸµ éŸ³æ•ˆ A (å¼·åŒ–éŸ³)</div>
  <div style="display:flex; width:90%; justify-content:space-around;">
      <div><div style="font-size:0.8rem; color:#888;">é…é€Ÿ</div><div id="bigPace" style="font-size:2.2rem; font-family:monospace;">--:--</div></div>
      <div><div style="font-size:0.8rem; color:#888;">æ™‚é–“</div><div id="bigElapsed" style="font-size:2.2rem; font-family:monospace;">00:00</div></div>
  </div>
  <button class="btn-start" style="width: 85%; background: var(--danger); margin-top: 30px;" onclick="stopAndSave()">çµæŸä¸¦å„²å­˜</button>
</div>

<div class="card">
  <h2>ğŸƒ è·‘æ­¥æ•™ç·´ V4.5.9</h2>
  <table>
    <tbody>
      <tr><td><b>ç†±èº«</b></td><td>BPM <input type="number" id="bpm0"></td><td>ç§’ <input type="number" id="sec0"></td></tr>
      <tr><td><b>é–“æ­‡</b></td><td>BPM <input type="number" id="bpm1"></td><td>ç§’ <input type="number" id="sec1"></td></tr>
      <tr><td><b>è¡åˆº</b></td><td>BPM <input type="number" id="bpm2"></td><td>ç§’ <input type="number" id="sec2"></td></tr>
      <tr><td><b>æ¢å¾©</b></td><td>BPM <input type="number" id="bpm3"></td><td>ç§’ <input type="number" id="sec3"></td></tr>
      <tr><td><b>èˆ’ç·©</b></td><td>BPM <input type="number" id="bpm4"></td><td>ç§’ <input type="number" id="sec4"></td></tr>
    </tbody>
  </table>
  
  <div class="ctrl-row">
    <span>å¾ªç’°ï¼š<input id="loopCount" type="number" style="width:40px;"></span>
    <span>æ­¥é€²ï¼š<input id="thresholdStep" type="number" step="0.01" style="width:45px;"></span>
    <span>é è¨ˆ <b id="totalPlanTime" style="color:var(--primary)">0</b> åˆ†é˜</span>
  </div>

  <div class="thres-row">
    <span style="font-weight:bold;">GPSé–€æª»ï¼š<span class="liveThresDisp" style="color:var(--primary)">0.30</span>m</span>
    <div style="display:flex; gap:8px;">
        <button style="padding:8px 15px; border-radius:5px; border:1px solid #ccc; background:#fff;" onclick="adjThres(-1)">ï¼</button>
        <button style="padding:8px 15px; border-radius:5px; border:1px solid #ccc; background:#fff;" onclick="adjThres(1)">ï¼‹</button>
    </div>
  </div>
  
  <div style="display:flex; gap:10px;">
      <button onclick="toggleStart(true)" class="btn-start" style="background:var(--primary); flex:1;">1 é”æ¨™å¾Œå„²å­˜</button>
      <button onclick="toggleStart(false)" class="btn-start" style="background:var(--info); flex:1;">2 é”æ¨™å¾ŒçºŒè·‘</button>
  </div>
</div>

<div class="card">
    <strong style="display:block; margin-bottom:10px;">æ­·å²ç´€éŒ„</strong>
    <div id="historyContainer"></div>
</div>

<script>
const HISTORY_KEY = 'run_history_v459'; 
const CONFIG_KEY = 'run_config_v459';
const DEFAULT_BPM = [180, 205, 215, 195, 180];
const DEFAULT_SEC = [180, 60, 60, 120, 180];

let config = { bpm: [...DEFAULT_BPM], sec: [...DEFAULT_SEC], loops: 1, threshold: 0.30, step: 0.01 };
let isRunning = false, totalDist = 0, elapsedSec = 0, currentEditingId = null;
let audioCtx = null;
let startNote = { location: "å®šä½ä¸­...", weather: "ç²å–ä¸­..." };

function forceRender() {
    const saved = localStorage.getItem(CONFIG_KEY);
    if (saved) { try { Object.assign(config, JSON.parse(saved)); } catch(e) {} }
    for(let i=0; i<5; i++) {
        document.getElementById('bpm'+i).value = config.bpm[i] || DEFAULT_BPM[i];
        document.getElementById('sec'+i).value = (config.sec[i] !== undefined) ? config.sec[i] : DEFAULT_SEC[i];
        document.getElementById('bpm'+i).oninput = updateUI;
        document.getElementById('sec'+i).oninput = updateUI;
    }
    document.getElementById('loopCount').value = config.loops || 1;
    document.getElementById('loopCount').oninput = updateUI;
    document.getElementById('thresholdStep').value = config.step || 0.01;
    document.getElementById('thresholdStep').oninput = updateUI;
    syncThresUI(); calcTotalTime(); renderHistory();
}

function updateUI() {
    config.bpm = []; config.sec = [];
    for(let i=0; i<5; i++) {
        config.bpm.push(parseInt(document.getElementById('bpm'+i).value) || 0);
        config.sec.push(parseInt(document.getElementById('sec'+i).value) || 0);
    }
    config.loops = parseInt(document.getElementById('loopCount').value) || 1;
    config.step = parseFloat(document.getElementById('thresholdStep').value) || 0.01;
    localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
    calcTotalTime();
}

function calcTotalTime() { 
    let t = config.sec[0] + ((config.sec[1] + config.sec[2] + config.sec[3]) * config.loops) + config.sec[4]; 
    document.getElementById('totalPlanTime').innerText = (t/60).toFixed(1); 
}

function syncThresUI() {
    document.querySelectorAll('.liveThresDisp').forEach(el => el.innerText = config.threshold.toFixed(2));
}

function adjThres(dir) {
    config.threshold += (dir * config.step);
    syncThresUI();
    updateUI();
}

// --- å‚™è¨»ç·¨è¼¯å™¨ ---
function editNote(id) {
    currentEditingId = id;
    let recs = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    let rec = recs.find(r => r.id === id);
    document.getElementById('noteArea').value = rec.note || "";
    document.getElementById('noteModal').style.display = 'flex';
}
function closeNote() { document.getElementById('noteModal').style.display = 'none'; }
function saveNote() {
    let recs = JSON.parse(localStorage.getItem(HISTORY_KEY));
    let idx = recs.findIndex(r => r.id === currentEditingId);
    if (idx !== -1) {
        recs[idx].note = document.getElementById('noteArea').value;
        localStorage.setItem(HISTORY_KEY, JSON.stringify(recs));
        renderHistory();
    }
    closeNote();
}

function stopAndSave() {
  isRunning = false;
  if (totalDist > 1) {
    const records = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    const finalNote = `ğŸ“ èµ·é»ï¼š${startNote.location}\nâ˜€ï¸ å¤©æ°£ï¼š${startNote.weather}`;
    records.unshift({ 
        id: Date.now(), date: new Date().toLocaleString(), dist: (totalDist/1000).toFixed(3), 
        time: formatTime(elapsedSec), note: finalNote
    });
    localStorage.setItem(HISTORY_KEY, JSON.stringify(records));
  }
  location.reload();
}

function renderHistory() {
  const rec = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  document.getElementById('historyContainer').innerHTML = rec.length ? rec.map(r => `
    <div class="history-card">
        <div style="font-size:11px; color:#888;">ğŸ“… ${r.date}</div>
        <b style="font-size:1.2rem; color:var(--primary);">ğŸƒ ${r.dist} km | â±ï¸ ${r.time}</b>
        <div class="note-display">${r.note}</div>
        <div style="display:flex; gap:5px;">
            <button class="btn-sm" style="background:var(--note); flex:1;" onclick="editNote(${r.id})">ä¿®æ”¹å‚™è¨»</button>
            <button class="btn-sm" style="background:var(--danger); flex:1;" onclick="deleteRec(${r.id})">åˆªé™¤</button>
        </div>
    </div>
  `).join('') : '<div style="text-align:center;color:#aaa;padding:20px;">ç„¡ç´€éŒ„</div>';
}

function deleteRec(id) { if (confirm("åˆªé™¤ç´€éŒ„ï¼Ÿ")) { let recs = JSON.parse(localStorage.getItem(HISTORY_KEY)).filter(r => r.id !== id); localStorage.setItem(HISTORY_KEY, JSON.stringify(recs)); renderHistory(); } }
function formatTime(s) { return Math.floor(s/60).toString().padStart(2,'0')+":"+(s%60).toString().padStart(2,'0'); }

async function toggleStart(isAuto) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    document.getElementById('trainingOverlay').style.display = 'flex';
    isRunning = true;
    // æ¨¡æ“¬ä½ç½®æŠ“å–ï¼Œæ­£å¼ç‰ˆæœƒé€£å‹• GPS
    setTimeout(() => { startNote.location = "å®œè˜­ç¸£å†¬å±±é„‰"; startNote.weather = "æ°£æº« 17.5Â°C"; }, 1000);
}

window.onload = forceRender;
</script>
</body>
</html>
